================================================================================
  ESTRUCTURA DEL PROYECTO - SISTEMA COMEDOR BACROCORP
  ReorganizaciÃ³n y UnificaciÃ³n de APIs
================================================================================

FECHA: 2026-01-27
VERSIÃ“N: 2.0 (Unificada)

================================================================================
  ESTRUCTURA DE CARPETAS
================================================================================

Comedor/
â”œâ”€â”€ api/                           â† Cliente API unificado (USAR ESTE)
â”‚   â”œâ”€â”€ Api.php                    â† Archivo principal con todas las clases
â”‚   â””â”€â”€ README.txt                 â† DocumentaciÃ³n completa de uso
â”‚
â”œâ”€â”€ deprecated/                    â† Archivos obsoletos (NO USAR)
â”‚   â”œâ”€â”€ ApiClient.php              â† Cliente antiguo (reemplazado)
â”‚   â”œâ”€â”€ api_client.php             â† Cliente antiguo duplicado (reemplazado)
â”‚   â”œâ”€â”€ config_api.php             â† ConfiguraciÃ³n antigua (reemplazada)
â”‚   â”œâ”€â”€ token_manager.php          â† Gestor de tokens antiguo (reemplazado)
â”‚   â””â”€â”€ endpoint_helpers.php       â† Helpers antiguos (reemplazados)
â”‚
â”œâ”€â”€ tests/                         â† Scripts de prueba
â”‚   â”œâ”€â”€ test_api_unificada.php     â† Test completo del cliente nuevo
â”‚   â””â”€â”€ test_api.php               â† Test antiguo (deprecado)
â”‚
â”œâ”€â”€ examples/                      â† Ejemplos y referencias
â”‚   â”œâ”€â”€ backend_api_example.js     â† Ejemplo del backend en Node.js
â”‚   â””â”€â”€ PedidosComedor_Backend.php â† Ejemplo antiguo de backend PHP
â”‚
â”œâ”€â”€ Admiin.php                     â† Login (ACTUALIZADO para usar api/Api.php)
â”œâ”€â”€ AgendaPedidos1.php             â† Consulta de consumos (ACTUALIZADO)
â”œâ”€â”€ FormatCancel.php               â† Formulario de cancelaciones (ACTUALIZADO)
â”œâ”€â”€ MenUsuario.php                 â† MenÃº principal
â”œâ”€â”€ Menpedidos.php                 â† GestiÃ³n de pedidos
â”œâ”€â”€ admicome4.php                  â† Panel administrativo
â””â”€â”€ [otros archivos PHP del sistema]

================================================================================
  CAMBIOS PRINCIPALES
================================================================================

ANTES (DESORDENADO):
--------------------
- 5 archivos diferentes para manejar APIs:
  â€¢ ApiClient.php
  â€¢ api_client.php (duplicado)
  â€¢ config_api.php
  â€¢ token_manager.php
  â€¢ endpoint_helpers.php

- CÃ³digo duplicado y confuso
- Llamadas cURL dispersas en mÃºltiples archivos
- DifÃ­cil de mantener

DESPUÃ‰S (UNIFICADO):
--------------------
- 1 solo archivo: api/Api.php
- Estructura clara y organizada
- Archivos obsoletos movidos a /deprecated/
- Tests en /tests/
- Ejemplos en /examples/
- DocumentaciÃ³n completa en api/README.txt

================================================================================
  CÃ“MO USAR EL NUEVO SISTEMA
================================================================================

1. INCLUIR EL CLIENTE
---------------------
require_once __DIR__ . '/api/Api.php';

2. EJEMPLO DE USO EN CUALQUIER ARCHIVO
---------------------------------------
<?php
require_once __DIR__ . '/api/Api.php';

// Verificar autenticaciÃ³n
if (!Api::isAuthenticated()) {
    header("Location: Admiin.php");
    exit;
}

// Obtener usuario actual
$user = Api::getCurrentUser();
echo "Bienvenido " . $user['nombre'];

// Obtener pedidos
$pedidos = Api::pedidos()->misPedidos();
if ($pedidos['success']) {
    foreach ($pedidos['data'] as $pedido) {
        echo $pedido['fecha'] . " - " . $pedido['tipo'];
    }
}

// Crear cancelaciÃ³n
$resultado = Api::cancelaciones()->crear([
    'jefe' => 'Juan PÃ©rez',
    'tipo_consumo' => 'DESAYUNO',
    'fecha' => '2026-01-28',
    'causa' => 'SALUD'
]);

if ($resultado['success']) {
    echo "CancelaciÃ³n registrada";
} else {
    echo "Error: " . $resultado['error'];
}
?>

================================================================================
  ARCHIVOS ACTUALIZADOS
================================================================================

âœ… Admiin.php
   - Cambiado: require_once __DIR__ . '/api/Api.php'
   - Usa: Api::auth()->login($usuario, $password)

âœ… AgendaPedidos1.php
   - Cambiado: require_once __DIR__ . '/api/Api.php'
   - Usa: Api::isAuthenticated()
   - Usa: Api::getCurrentUser()
   - Usa: Api::consumos()->misConsumos($fecha)

âœ… FormatCancel.php
   - Cambiado: require_once __DIR__ . '/api/Api.php'
   - Usa: Api::isAuthenticated()
   - Usa: Api::getCurrentUser()
   - Usa: Api::cancelaciones()->validaciones()
   - Usa: Api::cancelaciones()->crear($datos)

================================================================================
  MÃ“DULOS DISPONIBLES EN api/Api.php
================================================================================

1. Api::auth()
   - login($usuario, $password)
   - logout()
   - validarToken()
   - refrescarToken()

2. Api::pedidos()
   - perfil()
   - verificar($fecha)
   - crear($fechaSemana, $desayunos, $comidas)
   - misPedidos()
   - semanasDisponibles()

3. Api::consumos()
   - misConsumos($fecha)
   - estadisticas()

4. Api::cancelaciones()
   - validaciones()
   - crear($datos)
   - misCancelaciones()

5. Api::empleados()
   - perfil()
   - listar()
   - crear($datos)
   - actualizar($id, $datos)
   - eliminar($id)

6. Api::menu()
   - listar()
   - semana($fecha)
   - crear($datos)
   - actualizar($id, $datos)
   - eliminar($id)

7. Api::reportes()
   - dashboard()
   - detallado($params)
   - cancelaciones()
   - consumo()

8. UTILIDADES
   - Api::isAuthenticated()
   - Api::requireAuth()
   - Api::getCurrentUser()
   - Api::getToken()
   - Api::info()

================================================================================
  CONFIGURACIÃ“N DE ENTORNO
================================================================================

El sistema detecta automÃ¡ticamente el entorno:

LOCAL (127.0.0.1, localhost):
   URL API: http://127.0.0.1:3000

DESARROLLO (dev, desarollo en hostname):
   URL API: http://desarollo-bacros:3000

PRODUCCIÃ“N (Docker, IPs corporativas):
   URL API: http://host.docker.internal:3000

Para forzar un entorno especÃ­fico, editar api/Api.php lÃ­nea ~99:
   $this->entorno = 'local';  // local, desarrollo, produccion

================================================================================
  ENDPOINTS DEL BACKEND (Rust)
================================================================================

El backend corre en: http://127.0.0.1:3000

ENDPOINTS DISPONIBLES:
   âœ“ GET  /health                              - Estado del servidor
   âœ“ POST /auth/login                          - Login
   âœ“ GET  /auth/profile                        - Perfil del usuario
   âœ“ GET  /auth/verify                         - Verificar token
   âœ“ GET  /api/pedidos/perfil                  - Perfil para pedidos
   âœ“ GET  /api/pedidos/verificar               - Verificar lÃ­mite
   âœ“ POST /api/pedidos                         - Crear pedido
   âœ“ GET  /api/pedidos/mis-pedidos             - Mis pedidos
   âœ“ GET  /api/pedidos/semanas-disponibles     - Semanas disponibles
   âœ“ GET  /api/cancelaciones/validaciones      - Validaciones
   âœ“ POST /api/cancelaciones                   - Crear cancelaciÃ³n
   âœ“ GET  /api/cancelaciones/mis-cancelaciones - Mis cancelaciones
   âœ“ GET  /api/cancelaciones/pendientes        - Pendientes
   âœ“ GET  /api/empleados                       - InformaciÃ³n empleado
   âœ“ GET  /api/empleados/perfil                - Perfil empleado
   âœ“ GET  /api/reporte/reporte-detallado       - Reporte detallado

================================================================================
  PROBAR EL SISTEMA
================================================================================

1. VERIFICAR QUE EL BACKEND ESTÃ‰ CORRIENDO
-------------------------------------------
En la terminal del backend debe aparecer:
   INFO rust_backend_sqlserver: ğŸ”¥ Servidor ejecutÃ¡ndose en http://0.0.0.0:3000

Verificar con curl:
   curl http://127.0.0.1:3000/health

Debe responder:
   {"status":"ok","message":"Backend is running"}

2. EJECUTAR EL TEST AUTOMATIZADO
---------------------------------
cd "c:\Users\Boris.Ramirez\Downloads\Proyectos barcos produccion\Comedor"
php tests/test_api_unificada.php

Resultado esperado:
   âœ… LOGIN EXITOSO
   âœ… Token recibido
   âœ… Endpoints respondiendo

3. PROBAR EN EL NAVEGADOR
--------------------------
Abrir: http://localhost/Comedor/Admiin.php
   - Hacer login con credenciales vÃ¡lidas
   - Verificar que redirija a MenUsuario.php
   - Probar funcionalidades de pedidos y cancelaciones

================================================================================
  SOLUCIÃ“N DE PROBLEMAS
================================================================================

PROBLEMA: "Error de conexiÃ³n: Failed to connect to 127.0.0.1 port 3000"
SOLUCIÃ“N:
   1. Verificar que el backend estÃ© corriendo:
      cd BackendRustBACROS
      cargo run

   2. Verificar que responda:
      curl http://127.0.0.1:3000/health

   3. Revisar firewall de Windows
   4. Verificar que el puerto 3000 no estÃ© ocupado:
      netstat -ano | findstr :3000

PROBLEMA: "Error HTTP 404"
SOLUCIÃ“N:
   - Verificar que la URL base sea correcta en api/Api.php
   - Verificar que los endpoints existan en el backend
   - Revisar los logs del backend

PROBLEMA: "Token invÃ¡lido o expirado"
SOLUCIÃ“N:
   - Hacer logout y volver a hacer login
   - Verificar que $_SESSION estÃ© funcionando
   - session_start() debe estar al inicio de cada archivo

PROBLEMA: "Usuario no autenticado"
SOLUCIÃ“N:
   - Verificar que haya hecho login en Admiin.php
   - Verificar que la sesiÃ³n persista entre pÃ¡ginas
   - Revisar cookies de sesiÃ³n en el navegador

================================================================================
  MANTENIMIENTO FUTURO
================================================================================

AGREGAR UN NUEVO ENDPOINT:
---------------------------
Editar api/Api.php y agregar el mÃ©todo en la clase correspondiente:

class PedidosApi {
    public function nuevoMetodo($params) {
        return $this->http->get('api/pedidos/nuevo-endpoint', $params);
    }
}

Usar en cualquier archivo:
$resultado = Api::pedidos()->nuevoMetodo(['param' => 'valor']);

CREAR UN NUEVO MÃ“DULO:
-----------------------
Editar api/Api.php y agregar una nueva clase:

class NuevoModuloApi {
    private $http;

    public function __construct() {
        $this->http = new HttpClient();
    }

    public function metodo1() {
        return $this->http->get('api/nuevo-modulo/metodo1');
    }
}

Agregar en la clase Api:
private static $nuevoModulo;
public static function nuevoModulo() {
    return self::$nuevoModulo ??= new NuevoModuloApi();
}

Usar:
$resultado = Api::nuevoModulo()->metodo1();

================================================================================
  BENEFICIOS DE LA NUEVA ESTRUCTURA
================================================================================

âœ… CÃ³digo limpio y organizado
âœ… Un solo punto de entrada (api/Api.php)
âœ… FÃ¡cil de mantener y extender
âœ… DocumentaciÃ³n completa
âœ… Tests automatizados
âœ… Manejo automÃ¡tico de tokens
âœ… DetecciÃ³n automÃ¡tica de entorno
âœ… Manejo consistente de errores
âœ… Compatibilidad con cÃ³digo legacy

================================================================================
  ARCHIVOS A NO TOCAR (DEPRECADOS)
================================================================================

NO USAR ESTOS ARCHIVOS (estÃ¡n en /deprecated/):
   âŒ deprecated/ApiClient.php
   âŒ deprecated/api_client.php
   âŒ deprecated/config_api.php
   âŒ deprecated/token_manager.php
   âŒ deprecated/endpoint_helpers.php

Se mantienen SOLO como referencia histÃ³rica.
TODO EL CÃ“DIGO NUEVO DEBE USAR: api/Api.php

================================================================================
  MIGRACIÃ“N COMPLETA
================================================================================

ARCHIVOS MIGRADOS:
   âœ… Admiin.php             â†’ Usando api/Api.php
   âœ… AgendaPedidos1.php     â†’ Usando api/Api.php
   âœ… FormatCancel.php       â†’ Usando api/Api.php

ARCHIVOS POR MIGRAR (cuando sea necesario):
   â³ Menpedidos.php
   â³ MenUsuario.php
   â³ admicome4.php
   â³ ValidarFormatos.php
   â³ descUsuario.php
   â³ dem1.php

Cuando necesites actualizar un archivo, simplemente:
   1. Cambiar: require_once 'config_api.php'
      Por: require_once __DIR__ . '/api/Api.php'

   2. Reemplazar llamadas cURL directas por:
      Api::modulo()->metodo()

   3. Usar Api::isAuthenticated() en lugar de verificaciones manuales

================================================================================
  CONTACTO Y SOPORTE
================================================================================

Para reportar problemas:
   - Revisar api/README.txt
   - Ejecutar tests/test_api_unificada.php
   - Revisar logs de PHP (error_log)
   - Revisar logs del backend Rust

Archivos de configuraciÃ³n:
   - api/Api.php (configuraciÃ³n y cliente)
   - api/README.txt (documentaciÃ³n)
   - ESTRUCTURA_PROYECTO.txt (este archivo)

================================================================================
  FIN DEL DOCUMENTO
================================================================================
