<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Alarmas - Comedor</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0066cc 0%, #0099ff 50%, #66ccff 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 40px 0;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: white;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            color: white;
        }

        .ducking-indicator {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
            margin: 10px auto;
            font-weight: bold;
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .alarms-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .alarm-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 102, 204, 0.3);
            transition: transform 0.3s ease;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .alarm-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 102, 204, 0.4);
        }

        .alarm-card h3 {
            color: #0066cc;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #0099ff;
            padding-bottom: 10px;
        }

        .alarm-times {
            list-style: none;
            padding: 0;
        }

        .alarm-times li {
            padding: 10px;
            margin: 5px 0;
            background: #f0f7ff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 4px solid #0099ff;
        }

        .alarm-times li i {
            color: #0066cc;
        }

        .status-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 102, 204, 0.2);
            border: 1px solid rgba(0,102,204,0.1);
        }

        .status-panel h2 {
            color: #0066cc;
            margin-bottom: 20px;
        }

        .current-time {
            font-size: 3.5em;
            font-weight: bold;
            color: #0066cc;
            margin: 20px 0;
            font-family: monospace;
            background: #f0f7ff;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
        }

        .next-alarm {
            font-size: 1.3em;
            color: #0066cc;
            margin: 15px 0;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 10px;
        }

        .next-alarm i {
            margin-right: 10px;
            color: #0099ff;
        }

        .btn-test {
            background: linear-gradient(135deg, #0066cc 0%, #0099ff 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-test:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 102, 204, 0.4);
            background: linear-gradient(135deg, #0099ff 0%, #0066cc 100%);
        }

        /* Overlay de alarma */
        .alarm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0066cc 0%, #0099ff 50%, #66ccff 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        .alarm-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .alarm-content {
            text-align: center;
            color: white;
            animation: pulse 1s infinite;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            max-width: 800px;
            width: 90%;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .alarm-icon {
            font-size: 8em;
            margin-bottom: 20px;
            animation: ring 0.5s infinite alternate;
            color: white;
        }

        @keyframes ring {
            0% { transform: rotate(-10deg); }
            100% { transform: rotate(10deg); }
        }

        .alarm-title {
            font-size: 4em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: white;
        }

        .alarm-message {
            font-size: 2em;
            margin-bottom: 30px;
            color: white;
        }

        .alarm-type {
            font-size: 2.5em;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            padding: 15px 30px;
            border-radius: 50px;
            margin-bottom: 20px;
            color: white;
        }

        .voice-message-box {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #ffd700;
        }

        .voice-message-text {
            font-size: 1.8em;
            color: #ffd700;
            font-style: italic;
            margin: 0;
        }

        .countdown {
            font-size: 2em;
            margin-top: 20px;
            color: white;
        }

        .countdown-number {
            font-size: 4em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: normal;
        }

        .badge-morning {
            background: #0066cc;
            color: white;
        }

        .badge-afternoon {
            background: #0099ff;
            color: white;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: white;
        }

        .info-box {
            background: #f0f7ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #0066cc;
        }

        .info-box i {
            margin-right: 10px;
            color: #0099ff;
        }

        .audio-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            color: #0066cc;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            border: 2px solid #0099ff;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,102,204,0.3);
        }

        .audio-indicator i {
            color: #0066cc;
            animation: sound-wave 1s infinite;
        }

        @keyframes sound-wave {
            0% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.5; transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Overlay de Alarma -->
    <div id="alarmOverlay" class="alarm-overlay">
        <div class="alarm-content">
            <i class="bi bi-megaphone-fill alarm-icon"></i>
            <div class="alarm-title">¬°ATENCI√ìN POR FAVOR!</div>
            <div class="alarm-message" id="alarmMessage">EL TURNO HA TERMINADO</div>
            <div class="alarm-type" id="alarmType">DESAYUNO</div>
            
            <!-- Mensaje de voz en texto -->
            <div class="voice-message-box">
                <i class="bi bi-volume-up-fill" style="color: #ffd700; font-size: 2em;"></i>
                <div class="voice-message-text" id="voiceMessageText">
                    "Atenci√≥n por favor. El turno de desayuno ha terminado. Les pedimos amablemente que desalojen el comedor. Muchas gracias."
                </div>
            </div>
            
            <!-- Indicador de Ducking (se muestra cuando la alarma est√° activa) -->
            <div class="ducking-indicator" id="duckingIndicator" style="display: none;">
                <i class="bi bi-soundwave"></i> AUDIO DUCKING ACTIVADO
            </div>
            
            <div class="countdown">
                <i class="bi bi-hourglass-split"></i>
                <span class="countdown-number" id="countdown">45</span> segundos
            </div>
        </div>
    </div>

    <!-- Indicador de Audio -->
    <div class="audio-indicator" id="audioIndicator">
        <i class="bi bi-volume-up-fill"></i>
        <span>Sistema de Voz con Ducking Activado</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="bi bi-bell-fill"></i> Sistema de Alarmas - Comedor</h1>
            <p>Gesti√≥n autom√°tica de turnos con mensajes de voz</p>
        </div>

        <!-- Panel de Estado -->
        <div class="status-panel">
            <i class="bi bi-clock-history" style="font-size: 2.5em; color: #0066cc;"></i>
            <h2>Estado del Sistema</h2>
            
            <div class="current-time" id="currentTime"></div>
            <div class="next-alarm" id="nextAlarm">
                <i class="bi bi-alarm"></i>
                Calculando pr√≥xima alarma...
            </div>
            
            <button class="btn-test" onclick="testAlarm()">
                <i class="bi bi-play-circle"></i> Probar Alarma (45 seg)
            </button>
            <p style="margin-top: 10px; color: #0066cc; font-size: 0.9em;">
                <i class="bi bi-info-circle"></i> Al activarse, el volumen de otras aplicaciones NO se modifica (prueba con Spotify)
            </p>
        </div>

        <!-- Horarios de Alarmas -->
        <div class="alarms-container">
            <!-- Desayuno -->
            <div class="alarm-card">
                <h3><i class="bi bi-sunrise"></i> Desayuno</h3>
                <ul class="alarm-times">
                    <li>
                        <span><i class="bi bi-clock"></i> 8:50 AM</span>
                        <span class="badge badge-morning">Turno 1</span>
                    </li>
                    <li>
                        <span><i class="bi bi-clock"></i> 9:15 AM</span>
                        <span class="badge badge-morning">Turno 2</span>
                    </li>
                    <li>
                        <span><i class="bi bi-clock"></i> 9:40 AM</span>
                        <span class="badge badge-morning">Turno 3</span>
                    </li>
                    <li>
                        <span><i class="bi bi-clock"></i> 10:05 AM</span>
                        <span class="badge badge-morning">Turno 4</span>
                    </li>
                </ul>
            </div>

            <!-- Comida -->
            <div class="alarm-card">
                <h3><i class="bi bi-sunset"></i> Comida</h3>
                <ul class="alarm-times">
                    <li>
                        <span><i class="bi bi-clock"></i> 1:30 PM</span>
                        <span class="badge badge-afternoon">Turno 1</span>
                    </li>
                    <li>
                        <span><i class="bi bi-clock"></i> 2:05 PM</span>
                        <span class="badge badge-afternoon">Turno 2</span>
                    </li>
                    <li>
                        <span><i class="bi bi-clock"></i> 2:40 PM</span>
                        <span class="badge badge-afternoon">Turno 3</span>
                    </li>
                    <li>
                        <span><i class="bi bi-clock"></i> 3:15 PM</span>
                        <span class="badge badge-afternoon">Turno 4</span>
                    </li>
              
                </ul>
            </div>

            <!-- Mensajes de Voz -->
            <div class="alarm-card">
                <h3><i class="bi bi-megaphone"></i> Mensajes de Voz</h3>
                <div class="info-box">
                    <p><i class="bi bi-check-circle-fill"></i> <strong>Desayuno:</strong></p>
                    <p style="font-size: 0.9em; margin-left: 20px;">"Atenci√≥n por favor. El turno de desayuno ha terminado. Les pedimos amablemente que desalojen el comedor. Muchas gracias."</p>
                    
                    <p><i class="bi bi-check-circle-fill"></i> <strong>Comida:</strong></p>
                    <p style="font-size: 0.9em; margin-left: 20px;">"Atenci√≥n por favor. El turno de comida ha terminado. Les pedimos amablemente que desalojen el comedor. Muchas gracias."</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Sistema de Alarmas v6.0 - Listo para probar con Spotify</p>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA DE ALARMAS - VERSI√ìN FINAL
        // SIN CONTROLES DE M√öSICA - PARA PROBAR CON SPOTIFY
        // ============================================
        
        // Variables globales
        let alarmInterval;
        let alarmTimerInterval;
        let voiceInterval;
        let isAlarmActive = false;
        let currentAlarmType = '';
        let speechSynthesis = window.speechSynthesis;
        let voice = null;

        // Mensajes de voz EXACTOS del original
        const voiceMessages = {
            desayuno: [
                "Atenci√≥n por favor. El turno de desayuno ha terminado. Les pedimos amablemente que desalojen el comedor. Muchas gracias.",
                "Buenos d√≠as. El tiempo de desayuno ha concluido. Favor de retirarse del comedor. Gracias."
            ],
            comida: [
                "Atenci√≥n por favor. El turno de comida ha terminado. Les pedimos amablemente que desalojen el comedor. Muchas gracias.",
                "Buenas tardes. El tiempo de comida ha concluido. Favor de retirarse del comedor. Gracias."
            ]
        };

        // Horarios de desayuno
        const morningAlarms = [
            { hour: 8, minute: 50, type: 'DESAYUNO' },
            { hour: 9, minute: 15, type: 'DESAYUNO' },
            { hour: 9, minute: 40, type: 'DESAYUNO' },
            { hour: 10, minute: 5, type: 'DESAYUNO' }
        ];

        // Horarios de comida
        const afternoonAlarms = [
            { hour: 13, minute: 30, type: 'COMIDA' },
            { hour: 14, minute: 5, type: 'COMIDA' },
            { hour: 14, minute: 40, type: 'COMIDA' },
            { hour: 15, minute: 15, type: 'COMIDA' }
           
        ];

        // Inicializar voz en espa√±ol
        function initVoice() {
            if (speechSynthesis) {
                speechSynthesis.getVoices();
                
                setTimeout(() => {
                    const voices = speechSynthesis.getVoices();
                    voice = voices.find(v => v.lang.includes('es') || v.name.includes('Spanish') || v.name.includes('Espa√±ol'));
                    
                    if (voice) {
                        console.log('üé§ Voz cargada:', voice.name);
                    }
                }, 500);
            }
        }

        // Funci√≥n para hablar
        function speak(message) {
            if (!speechSynthesis) return;
            
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(message);
            
            if (voice) utterance.voice = voice;
            utterance.lang = 'es-MX';
            utterance.rate = 0.8;
            utterance.pitch = 1;
            utterance.volume = 1.0;
            
            speechSynthesis.speak(utterance);
        }

        // Funci√≥n para activar la alarma
        function activateAlarm(type) {
            if (isAlarmActive) {
                deactivateAlarm();
                setTimeout(() => activateAlarm(type), 500);
                return;
            }

            console.log('üîî ACTIVANDO ALARMA:', type);
            isAlarmActive = true;
            currentAlarmType = type;

            // Mostrar indicador de ducking (solo visual)
            document.getElementById('duckingIndicator').style.display = 'inline-block';

            const ahora = new Date();
            const horaStr = ahora.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });

            // Determinar tipo de mensaje
            const isDesayuno = type === 'DESAYUNO' || type.includes('DESAYUNO');
            const messages = isDesayuno ? voiceMessages.desayuno : voiceMessages.comida;
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            // Actualizar overlay
            document.getElementById('voiceMessageText').textContent = `"${randomMessage}"`;
            document.getElementById('alarmMessage').textContent = `TURNO DE ${isDesayuno ? 'DESAYUNO' : 'COMIDA'} TERMINADO`;
            document.getElementById('alarmType').textContent = isDesayuno ? 'DESAYUNO' : 'COMIDA';

            // Mostrar overlay
            const overlay = document.getElementById('alarmOverlay');
            overlay.classList.add('active');

            // REPRODUCIR MENSAJE DE VOZ
            setTimeout(() => { speak(randomMessage); }, 200);

            // Sonido de alarma cada 4 segundos
            alarmInterval = setInterval(() => {
                if (isAlarmActive) playAlarmSound();
            }, 4000);

            // Repetir voz cada 10 segundos
            let voiceCount = 0;
            voiceInterval = setInterval(() => {
                if (isAlarmActive && voiceCount < 4) {
                    const repeatMessage = messages[Math.floor(Math.random() * messages.length)];
                    speak(repeatMessage);
                    voiceCount++;
                }
            }, 10000);

            // Temporizador de 45 segundos
            let secondsLeft = 45;
            document.getElementById('countdown').textContent = secondsLeft;

            alarmTimerInterval = setInterval(() => {
                secondsLeft--;
                document.getElementById('countdown').textContent = secondsLeft;

                if (secondsLeft <= 0) {
                    deactivateAlarm();
                }
            }, 1000);
        }

        // Funci√≥n para desactivar la alarma
        function deactivateAlarm() {
            console.log('üîï DESACTIVANDO ALARMA');
            isAlarmActive = false;

            // Limpiar intervalos
            clearInterval(alarmTimerInterval);
            clearInterval(alarmInterval);
            clearInterval(voiceInterval);

            // Cancelar voz
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }

            // Ocultar indicador de ducking
            document.getElementById('duckingIndicator').style.display = 'none';

            // Ocultar overlay
            document.getElementById('alarmOverlay').classList.remove('active');

            // Calcular pr√≥xima alarma
            calculateNextAlarm();
        }

        // Funci√≥n para reproducir sonido de alarma
        function playAlarmSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const now = audioContext.currentTime;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                for (let i = 0; i < 3; i++) {
                    const startTime = now + (i * 0.3);
                    
                    oscillator.frequency.setValueAtTime(523.25, startTime);
                    oscillator.frequency.setValueAtTime(587.33, startTime + 0.15);
                    oscillator.frequency.setValueAtTime(659.25, startTime + 0.3);
                    
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(0.2, startTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, startTime + 0.4);
                }
                
                oscillator.start(now);
                oscillator.stop(now + 1.2);
                
            } catch (e) {
                console.error('Error reproduciendo sonido:', e);
            }
        }

        // Funci√≥n para verificar alarmas
        function checkAlarms() {
            if (isAlarmActive) return;

            const ahora = new Date();
            const hora = ahora.getHours();
            const minuto = ahora.getMinutes();

            // Verificar desayuno
            morningAlarms.forEach(alarma => {
                if (hora === alarma.hour && minuto === alarma.minute) {
                    activateAlarm(alarma.type);
                }
            });

            // Verificar comida
            afternoonAlarms.forEach(alarma => {
                if (hora === alarma.hour && minuto === alarma.minute) {
                    activateAlarm(alarma.type);
                }
            });
        }

        // Funci√≥n para calcular pr√≥xima alarma
        function calculateNextAlarm() {
            const ahora = new Date();
            const todasAlarmas = [...morningAlarms, ...afternoonAlarms];
            let proximaAlarma = null;
            let menorDiferencia = Infinity;

            todasAlarmas.forEach(alarma => {
                const tiempoAlarma = new Date();
                tiempoAlarma.setHours(alarma.hour, alarma.minute, 0, 0);
                
                if (tiempoAlarma > ahora) {
                    const diferencia = tiempoAlarma - ahora;
                    if (diferencia < menorDiferencia) {
                        menorDiferencia = diferencia;
                        proximaAlarma = { ...alarma, tiempo: tiempoAlarma };
                    }
                }
            });

            if (!proximaAlarma) {
                const manana = new Date(ahora);
                manana.setDate(manana.getDate() + 1);
                manana.setHours(8, 50, 0, 0);
                
                const horas = Math.floor((manana - ahora) / (1000 * 60 * 60));
                const minutos = Math.floor(((manana - ahora) % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('nextAlarm').innerHTML = `
                    <i class="bi bi-alarm"></i>
                    Pr√≥xima alarma: Ma√±ana 8:50 AM (en ${horas}h ${minutos}m)
                `;
            } else {
                const horas = Math.floor(menorDiferencia / (1000 * 60 * 60));
                const minutos = Math.floor((menorDiferencia % (1000 * 60 * 60)) / (1000 * 60));
                
                const horaStr = proximaAlarma.tiempo.getHours().toString().padStart(2, '0');
                const minutoStr = proximaAlarma.tiempo.getMinutes().toString().padStart(2, '0');
                
                document.getElementById('nextAlarm').innerHTML = `
                    <i class="bi bi-alarm"></i>
                    Pr√≥xima alarma: ${proximaAlarma.type} - ${horaStr}:${minutoStr} (en ${horas}h ${minutos}m)
                `;
            }
        }

        // Funci√≥n para actualizar reloj
        function updateClock() {
            const ahora = new Date();
            const hours = ahora.getHours().toString().padStart(2, '0');
            const minutes = ahora.getMinutes().toString().padStart(2, '0');
            const seconds = ahora.getSeconds().toString().padStart(2, '0');
            
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
        }

        // Funci√≥n para probar alarma
        function testAlarm() {
            if (isAlarmActive) {
                deactivateAlarm();
                setTimeout(() => activateAlarm('PRUEBA'), 500);
            } else {
                activateAlarm('PRUEBA');
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando Sistema de Alarmas - VERSI√ìN FINAL');
            
            initVoice();
            
            // Actualizar reloj cada segundo
            setInterval(updateClock, 1000);
            updateClock();
            
            // Verificar alarmas cada segundo
            setInterval(checkAlarms, 1000);
            
            // Calcular pr√≥xima alarma
            calculateNextAlarm();
            setInterval(calculateNextAlarm, 60000);
            
            // Mensaje de bienvenida
            setTimeout(() => {
                speak("Sistema de alarmas activado. Listo para pr√≥ximo turno.");
            }, 2000);
        });

        console.log('‚úÖ Sistema listo - Ahora puedes probar con Spotify');
    </script>
</body>
</html>