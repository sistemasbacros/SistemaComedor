name: Deploy to Production Server

on:
  push:
    branches:
      - main # Producci√≥n se despliega desde main
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub UI

env:
  DEPLOY_PATH: C:\deploy\ComedorProduccion
  COMPOSE_FILE: docker-compose.yml

jobs:
  deploy:
    name: Build and Deploy to Production Server
    runs-on: [self-hosted, Windows, X64, production, comedor] # Ejecuta solo en runners Windows con label "production" y "comedor"
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
      
      - name: üìÇ Create deploy directory
        run: |
          if (-not (Test-Path "$env:DEPLOY_PATH")) {
            New-Item -Path "$env:DEPLOY_PATH" -ItemType Directory -Force
            Write-Host "[OK] Directorio de despliegue creado"
          }
        shell: powershell
      
      - name: üìã Copy .env if not exists
        run: |
          if (-not (Test-Path "$env:DEPLOY_PATH\.env")) {
            if (Test-Path ".env.example") {
              Copy-Item -Path ".env.example" -Destination "$env:DEPLOY_PATH\.env" -Force
              Write-Host "[WARNING] Archivo .env creado desde template"
              Write-Host "[WARNING] IMPORTANTE: Configurar manualmente con credenciales de PRODUCCI√ìN"
              Write-Host "[ERROR] Detener el deployment y configurar .env antes de continuar"
              exit 1
            }
          } else {
            Write-Host "[INFO] Archivo .env ya existe"
          }
        shell: powershell
      
      - name: üíæ Backup current deployment
        run: |
          if (Test-Path "$env:DEPLOY_PATH") {
            $backupPath = "$env:DEPLOY_PATH\..\ComedorProduccion_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
            Write-Host "[INFO] Creando backup en: $backupPath"
            Copy-Item -Path "$env:DEPLOY_PATH" -Destination "$backupPath" -Recurse -Force
            Write-Host "[OK] Backup creado exitosamente"
          } else {
            Write-Host "[INFO] No hay deployment previo para hacer backup"
          }
        shell: powershell
        continue-on-error: true
      
      - name: üöÄ Deploy files to production server
        run: |
          Write-Host "[INFO] Desplegando archivos a PRODUCCI√ìN..."
          
          # Copiar todos los archivos excepto .env y logs
          $excludeItems = @('.env', 'nginx/logs', '.git', 'README.md')
          
          Get-ChildItem -Path "." -Recurse | ForEach-Object {
            $shouldExclude = $false
            foreach ($exclude in $excludeItems) {
              if ($_.FullName -like "*$exclude*") {
                $shouldExclude = $true
                break
              }
            }
            
            if (-not $shouldExclude -and -not $_.PSIsContainer) {
              $relativePath = $_.FullName.Substring((Get-Location).Path.Length + 1)
              $destPath = Join-Path $env:DEPLOY_PATH $relativePath
              $destDir = Split-Path $destPath -Parent
              
              if (-not (Test-Path $destDir)) {
                New-Item -Path $destDir -ItemType Directory -Force | Out-Null
              }
              
              Copy-Item -Path $_.FullName -Destination $destPath -Force
            }
          }
          
          Write-Host "[OK] Archivos desplegados en $env:DEPLOY_PATH"
        shell: powershell
      
      - name: üê≥ Verify Docker installation
        run: |
          try {
            $dockerVersion = docker --version
            Write-Host "[OK] Docker instalado: $dockerVersion"
            
            $composeVersion = docker compose version
            Write-Host "[OK] Docker Compose instalado: $composeVersion"
          } catch {
            Write-Host "[ERROR] Docker no est√° instalado o no est√° en el PATH"
            exit 1
          }
        shell: powershell
      
      - name: üõë Stop current containers
        run: |
          cd $env:DEPLOY_PATH
          
          if (Test-Path "$env:COMPOSE_FILE") {
            Write-Host "[INFO] Deteniendo contenedores de PRODUCCI√ìN..."
            docker compose -f $env:COMPOSE_FILE down
            Write-Host "[OK] Contenedores detenidos"
          } else {
            Write-Host "[INFO] No hay contenedores corriendo"
          }
        shell: powershell
        continue-on-error: true
      
      - name: üèóÔ∏è Build Docker images
        run: |
          cd $env:DEPLOY_PATH
          
          Write-Host "[INFO] Construyendo im√°genes Docker para PRODUCCI√ìN..."
          docker compose -f $env:COMPOSE_FILE build --no-cache
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] Im√°genes construidas exitosamente"
          } else {
            Write-Host "[ERROR] Error al construir im√°genes"
            exit 1
          }
        shell: powershell
      
      - name: üöÄ Start containers
        run: |
          cd $env:DEPLOY_PATH
          
          Write-Host "[INFO] Iniciando contenedores de PRODUCCI√ìN..."
          docker compose -f $env:COMPOSE_FILE up -d
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] Contenedores iniciados exitosamente"
          } else {
            Write-Host "[ERROR] Error al iniciar contenedores"
            exit 1
          }
        shell: powershell
      
      - name: üîç Verify containers status
        run: |
          cd $env:DEPLOY_PATH
          
          Write-Host "[INFO] Verificando estado de contenedores..."
          Start-Sleep -Seconds 10
          
          $containers = docker compose -f $env:COMPOSE_FILE ps --format json | ConvertFrom-Json
          
          $allRunning = $true
          foreach ($container in $containers) {
            if ($container.State -ne "running") {
              Write-Host "[ERROR] Contenedor $($container.Service) no est√° corriendo. Estado: $($container.State)"
              $allRunning = $false
            } else {
              Write-Host "[OK] Contenedor $($container.Service) corriendo correctamente"
            }
          }
          
          if (-not $allRunning) {
            Write-Host "[ERROR] Algunos contenedores no est√°n corriendo correctamente"
            Write-Host "--- LOGS DE NGINX ---"
            docker compose -f $env:COMPOSE_FILE logs nginx
            Write-Host "--- LOGS DE PHP ---"
            docker compose -f $env:COMPOSE_FILE logs php
            exit 1
          }
        shell: powershell
      
      - name: üè• Health check
        run: |
          Write-Host "[INFO] Verificando salud del servidor de PRODUCCI√ìN..."
          $maxAttempts = 30
          $attempt = 0
          $healthy = $false
          
          # Leer el puerto del archivo .env
          $envContent = Get-Content "$env:DEPLOY_PATH\.env"
          $port = 80
          foreach ($line in $envContent) {
            if ($line -match "HTTP_PORT=(\d+)") {
              $port = $matches[1]
              break
            }
          }
          
          while ($attempt -lt $maxAttempts) {
            try {
              Start-Sleep -Seconds 3
              $response = Invoke-WebRequest -Uri "http://localhost:$port" -UseBasicParsing -TimeoutSec 5
              
              if ($response.StatusCode -eq 200) {
                Write-Host "[OK] Servidor de PRODUCCI√ìN respondiendo correctamente: $($response.StatusCode)"
                $healthy = $true
                break
              }
            } catch {
              $attempt++
              Write-Host "[WAITING] Intento $attempt/$maxAttempts - Esperando respuesta del servidor..."
            }
          }
          
          if (-not $healthy) {
            Write-Host "[ERROR] Servidor no responde despu√©s de $maxAttempts intentos"
            Write-Host "[WARNING] Revisar logs de contenedores"
            
            cd $env:DEPLOY_PATH
            Write-Host "--- LOGS DE NGINX ---"
            docker compose -f $env:COMPOSE_FILE logs --tail=50 nginx
            Write-Host "--- LOGS DE PHP ---"
            docker compose -f $env:COMPOSE_FILE logs --tail=50 php
            
            exit 1
          }
        shell: powershell
      
      - name: üßπ Clean old images
        run: |
          Write-Host "[INFO] Limpiando im√°genes antiguas..."
          docker image prune -f
          Write-Host "[OK] Im√°genes antiguas eliminadas"
        shell: powershell
        continue-on-error: true
      
      - name: üìä Deployment summary
        run: |
          cd $env:DEPLOY_PATH
          
          # Leer el puerto del archivo .env
          $envContent = Get-Content "$env:DEPLOY_PATH\.env"
          $port = 80
          foreach ($line in $envContent) {
            if ($line -match "HTTP_PORT=(\d+)") {
              $port = $matches[1]
              break
            }
          }
          
          Write-Host ""
          Write-Host "============================================================="
          Write-Host "  DESPLIEGUE EN PRODUCCI√ìN COMPLETADO EXITOSAMENTE"
          Write-Host "============================================================="
          Write-Host ""
          Write-Host "Ubicaci√≥n: $env:DEPLOY_PATH"
          Write-Host "URL: http://localhost:$port"
          Write-Host "Fecha: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host "Commit: $env:GITHUB_SHA"
          Write-Host "Autor: $env:GITHUB_ACTOR"
          Write-Host "Branch: main (PRODUCCI√ìN)"
          Write-Host ""
          Write-Host "Contenedores corriendo:"
          docker compose -f $env:COMPOSE_FILE ps
          Write-Host ""
          Write-Host "[OK] Servidor de PRODUCCI√ìN actualizado y corriendo"
          Write-Host ""
        shell: powershell
      
      - name: üìß Notify on failure
        if: failure()
        run: |
          Write-Host ""
          Write-Host "============================================================="
          Write-Host "       DESPLIEGUE EN PRODUCCI√ìN FALL√ì"
          Write-Host "============================================================="
          Write-Host ""
          Write-Host "[INFO] Revisa los logs del workflow en GitHub Actions"
          Write-Host "[INFO] Revisa los logs de contenedores con:"
          Write-Host "       cd $env:DEPLOY_PATH"
          Write-Host "       docker compose -f $env:COMPOSE_FILE logs"
          Write-Host ""
          Write-Host "[INFO] Restaurar desde backup si es necesario"
          Write-Host ""
          
          # Intentar restaurar desde el √∫ltimo backup
          $backupFolders = Get-ChildItem -Path "$env:DEPLOY_PATH\.." -Directory -Filter "ComedorProduccion_backup_*" | Sort-Object Name -Descending
          
          if ($backupFolders.Count -gt 0) {
            $latestBackup = $backupFolders[0].FullName
            Write-Host "[INFO] √öltimo backup disponible: $latestBackup"
            Write-Host "[INFO] Para restaurar ejecuta:"
            Write-Host "       Remove-Item -Path '$env:DEPLOY_PATH' -Recurse -Force"
            Write-Host "       Copy-Item -Path '$latestBackup' -Destination '$env:DEPLOY_PATH' -Recurse"
            Write-Host "       cd $env:DEPLOY_PATH"
            Write-Host "       docker compose -f $env:COMPOSE_FILE up -d"
          }
        shell: powershell
